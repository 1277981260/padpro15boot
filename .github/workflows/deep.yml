name: OnePlus Pad Pro 6.1.118å®Œæ•´ç¼–è¯‘å·¥ä½œæµ

on:
  push:
    branches: [main]
    paths:
      - '.github/cmboo.c'
      - '.github/.config'
      - '.github/workflows/build-6.1.118-clang.yml'
  workflow_dispatch:

jobs:
  build-kernel-and-driver:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    
    steps:
      - name: æ¸…ç†+ç©ºé—´æ£€æŸ¥
        run: |
          rm -rf ~/.cache/* ~/.npm ~/.yarn ~/.local/share 2>/dev/null || true
          FREE_SPACE=$(df -h / | awk 'NR==2 {print $4}' | sed 's/G//')
          if (( $(echo "$FREE_SPACE < 10" | bc -l) )); then
            echo "âŒ ç©ºé—´ä¸è¶³30GB"
            exit 1
          fi
          echo "âœ… å‰©ä½™ç©ºé—´ï¼š$FREE_SPACE GB"

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: å®‰è£…ä¾èµ–ï¼ˆå®Œæ•´ç¼–è¯‘ç‰ˆï¼‰
        run: |
          sudo apt update && sudo apt install -y --no-install-recommends \
            git make libssl-dev bc libelf-dev python3 python3-pip zlib1g-dev bison flex \
            gcc-multilib g++-multilib rsync binutils-aarch64-linux-gnu \
            libncurses-dev lzop cpio kmod gawk wget bc
          sudo pip3 install pyelftools --no-cache-dir
          
          # å®‰è£…è°·æ­ŒClang
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/android-14.0.0_r1/clang-r487747c.tar.gz
          sudo mkdir -p /opt/clang && sudo tar -zxf clang-r487747c.tar.gz -C /opt/clang
          
          # å·¥å…·è½¯é“¾æ¥
          for tool in nm objdump objcopy strip; do
            sudo ln -sf /usr/bin/aarch64-linux-gnu-$tool /opt/clang/bin/aarch64-linux-android-$tool
          done
          sudo ln -sf /opt/clang/bin/clang /opt/clang/bin/aarch64-linux-android-clang
          sudo ln -sf /opt/clang/bin/ld.lld /opt/clang/bin/aarch64-linux-android-ld.lld
          
          # éªŒè¯å·¥å…·é“¾
          /opt/clang/bin/clang --version || { echo "âŒ Clangå¤±è´¥"; exit 1; }
          rm -f clang-r487747c.tar.gz

      - name: å†…æ ¸æºç å‡†å¤‡
        run: |
          mkdir -p ~/android-kernel && cd ~/android-kernel
          echo "ğŸ” å…‹éš†å†…æ ¸æºç  (android14-6.1.118_r00)..."
          
          # å…‹éš†å†…æ ¸
          git clone --branch android14-6.1 --single-branch --depth 150 \
            https://android.googlesource.com/kernel/common gki-6.1.118
          cd gki-6.1.118
          
          # æ£€æŸ¥ç‰¹å®šæäº¤
          git fetch origin 367540fdf98147e0e5cd42d42ff4867ebd8ea7ef && git checkout $_
          echo "âœ… å†…æ ¸æºç å°±ç»ª: $(git log --oneline -1)"
          
          # åº”ç”¨ä½ çš„è®¾å¤‡é…ç½®
          cp $GITHUB_WORKSPACE/.github/.config .config
          
          echo "ğŸ”§ æ¸…ç†å’Œå‡†å¤‡é…ç½®..."
          # æ¸…ç†ä¹‹å‰çš„æ„å»º
          make ARCH=arm64 distclean 2>/dev/null || true
          
          # ç¡®ä¿é…ç½®æ­£ç¡®
          echo "CONFIG_MODULES=y" >> .config
          echo "CONFIG_MODULE_UNLOAD=y" >> .config
          echo "# CONFIG_MODULE_SIG is not set" >> .config

      - name: å®Œæ•´ç¼–è¯‘å†…æ ¸ï¼ˆå…³é”®æ­¥éª¤ï¼‰
        run: |
          cd ~/android-kernel/gki-6.1.118
          
          echo "ğŸ› ï¸ ç”Ÿæˆå†…æ ¸é…ç½®..."
          # ç”Ÿæˆæœ€ç»ˆé…ç½®
          make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
               CC=/opt/clang/bin/clang LD=/opt/clang/bin/ld.lld olddefconfig -j$(nproc)
          
          echo "ğŸ“Š é…ç½®æ‘˜è¦ï¼š"
          grep -E "MODULES|MODULE|VERSION" .config | head -10
          
          echo "ğŸš€ å¼€å§‹å®Œæ•´ç¼–è¯‘å†…æ ¸ (è€—æ—¶è¾ƒé•¿)..."
          # å®Œæ•´ç¼–è¯‘å†…æ ¸ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ¨¡å—
          if make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
               CC=/opt/clang/bin/clang LD=/opt/clang/bin/ld.lld \
               -j$(nproc) 2>&1 | tee build.log; then
            echo "âœ… å†…æ ¸ç¼–è¯‘æˆåŠŸï¼"
          else
            echo "âŒ å†…æ ¸ç¼–è¯‘å¤±è´¥ï¼ŒæŸ¥çœ‹é”™è¯¯ï¼š"
            tail -100 build.log
            echo "å°è¯•æ¢å¤æ€§ç¼–è¯‘..."
            # å¦‚æœå®Œæ•´ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•åªç¼–è¯‘Imageå’Œæ¨¡å—
            make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
                 CC=/opt/clang/bin/clang LD=/opt/clang/bin/ld.lld Image.gz -j$(nproc)
            make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
                 CC=/opt/clang/bin/clang LD=/opt/clang/bin/ld.lld modules -j$(nproc)
          fi
          
          # éªŒè¯ç¼–è¯‘ç»“æœ
          echo "ğŸ“¦ ç¼–è¯‘äº§ç‰©æ£€æŸ¥ï¼š"
          [ -f "arch/arm64/boot/Image.gz" ] && echo "âœ… Image.gz å·²ç”Ÿæˆ"
          [ -f "vmlinux" ] && echo "âœ… vmlinux å·²ç”Ÿæˆ"
          [ -f "Module.symvers" ] && {
            SYM_COUNT=$(wc -l < Module.symvers)
            echo "âœ… Module.symvers å·²ç”Ÿæˆï¼ŒåŒ…å« $SYM_COUNT ä¸ªç¬¦å·"
          }
          [ -f "modules.order" ] && echo "âœ… modules.order å·²ç”Ÿæˆ"
          
          # æ˜¾ç¤ºå†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
          echo "ğŸ“‹ å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯ï¼š"
          make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
               kernelversion 2>/dev/null || true

      - name: ç¼–è¯‘é©±åŠ¨æ¨¡å—
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘é©±åŠ¨æ¨¡å—..."
          
          # åˆ›å»ºé©±åŠ¨ç›®å½•
          mkdir -p ~/gki-driver
          cp $GITHUB_WORKSPACE/.github/cmboo.c ~/gki-driver/
          cd ~/gki-driver
          
          # ç¼–å†™ä½¿ç”¨å®Œæ•´ç¼–è¯‘å†…æ ¸çš„Makefile
          cat > Makefile << 'EOF'
# é©±åŠ¨æ¨¡å—åç§°
obj-m += cmboo.o

# å†…æ ¸æ„å»ºç›®å½•ï¼ˆä½¿ç”¨å®Œæ•´ç¼–è¯‘çš„å†…æ ¸ï¼‰
KERNELDIR ?= $(HOME)/android-kernel/gki-6.1.118
PWD := $(shell pwd)
ARCH := arm64

# ä½¿ç”¨ä¸å†…æ ¸ç›¸åŒçš„ç¼–è¯‘å™¨å’Œæ ‡å¿—
# è¿™é‡Œä½¿ç”¨ç®€åŒ–çš„æ–¹å¼ï¼Œè®©å†…æ ¸çš„æ„å»ºç³»ç»Ÿå†³å®šå…·ä½“å‚æ•°

# ç¦ç”¨æ¨¡å—ç­¾åï¼ˆå¦‚æœéœ€è¦ï¼‰
CONFIG_MODULE_SIG=n

all:
	@echo "ä½¿ç”¨å®Œæ•´ç¼–è¯‘çš„å†…æ ¸æ„å»ºé©±åŠ¨..."
	@echo "å†…æ ¸ç¬¦å·è¡¨: $(KERNELDIR)/Module.symvers"
	
	# å…³é”®ï¼šä½¿ç”¨å†…æ ¸çš„æ„å»ºç³»ç»Ÿç¼–è¯‘é©±åŠ¨
	$(MAKE) -C $(KERNELDIR) \
		M=$(PWD) \
		ARCH=$(ARCH) \
		KBUILD_EXTMOD=$(PWD) \
		modules
	
	@if [ -f "cmboo.ko" ]; then \
		echo "âœ… é©±åŠ¨ç¼–è¯‘æˆåŠŸ"; \
		cp cmboo.ko crypto_evt.ko; \
		aarch64-linux-gnu-strip --strip-debug crypto_evt.ko 2>/dev/null || true; \
		echo "ç”Ÿæˆ: crypto_evt.ko"; \
	else \
		echo "âŒ é©±åŠ¨ç¼–è¯‘å¤±è´¥"; \
		exit 1; \
	fi

clean:
	rm -f *.ko *.o *.mod.c *.mod.o .*.cmd modules.order Module.symvers
EOF
          
          echo "å¼€å§‹ç¼–è¯‘é©±åŠ¨..."
          # ç¼–è¯‘é©±åŠ¨
          if make -j$(nproc) V=1 2>&1 | tee driver_build.log; then
            echo "âœ… é©±åŠ¨ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ é©±åŠ¨ç¼–è¯‘å¤±è´¥"
            echo "=== é”™è¯¯æ—¥å¿— ==="
            tail -50 driver_build.log
            exit 1
          fi
          
          # è¯¦ç»†éªŒè¯é©±åŠ¨
          echo "ğŸ” è¯¦ç»†éªŒè¯é©±åŠ¨æ¨¡å—..."
          if [ -f "crypto_evt.ko" ]; then
            echo "ğŸ“¦ æ¨¡å—æ–‡ä»¶ä¿¡æ¯ï¼š"
            file crypto_evt.ko
            ls -lh crypto_evt.ko
            
            echo "ğŸ”— æ¨¡å—ä¾èµ–æ£€æŸ¥ï¼š"
            # æ£€æŸ¥æ¨¡å—ä¿¡æ¯
            strings crypto_evt.ko | grep -E "^[0-9]" | head -5 || true
            
            echo "ğŸ“‹ æ¨¡å—ç‰ˆæœ¬é­”æœ¯ï¼š"
            modinfo ./crypto_evt.ko 2>/dev/null | grep -i vermagic || \
            strings crypto_evt.ko | grep -i vermagic || \
            echo "æ— æ³•æå–ç‰ˆæœ¬ä¿¡æ¯"
            
            echo "ğŸ” æœªå®šä¹‰ç¬¦å·æ£€æŸ¥ï¼š"
            UNDEF_SYMS=$(aarch64-linux-gnu-nm crypto_evt.ko 2>/dev/null | grep " U " | wc -l || echo "æœªçŸ¥")
            echo "æœªå®šä¹‰ç¬¦å·æ•°é‡: $UNDEF_SYMS"
            if [ "$UNDEF_SYMS" != "æœªçŸ¥" ] && [ "$UNDEF_SYMS" -gt 0 ]; then
              echo "å‰5ä¸ªæœªå®šä¹‰ç¬¦å·ï¼š"
              aarch64-linux-gnu-nm crypto_evt.ko 2>/dev/null | grep " U " | head -5
            fi
          fi

      - name: ç”ŸæˆåŠ è½½è„šæœ¬å’Œæ‰“åŒ…
        run: |
          mkdir -p output
          
          # å¤åˆ¶é©±åŠ¨æ–‡ä»¶
          cp ~/gki-driver/crypto_evt.ko output/
          
          # è·å–å†…æ ¸ç‰ˆæœ¬ä¿¡æ¯
          cd ~/android-kernel/gki-6.1.118
          KERNEL_VERSION=$(make ARCH=arm64 kernelversion 2>/dev/null || echo "6.1.118")
          
          # ç”Ÿæˆæ™ºèƒ½åŠ è½½è„šæœ¬
          cat > output/load_driver.sh << 'EOF'
#!/system/bin/sh
# OnePlus Pad Pro é©±åŠ¨åŠ è½½è„šæœ¬
# æ„å»ºæ—¶é—´: $(date)

set -euo pipefail

MODULE_NAME="cmboo"
MODULE_FILE="crypto_evt.ko"
MODULE_PATH="/data/local/tmp/$MODULE_FILE"

echo "=== OnePlus Pad Pro é©±åŠ¨åŠ è½½å·¥å…· ==="
echo "å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
echo "æ¨¡å—æ–‡ä»¶: $MODULE_FILE"
echo ""

# æ£€æŸ¥rootæƒé™
if [ "$(id -u)" -ne 0 ]; then
  echo "âš ï¸  éœ€è¦rootæƒé™"
  exit 1
fi

# å¤åˆ¶é©±åŠ¨åˆ°è®¾å¤‡
echo "å¤åˆ¶é©±åŠ¨åˆ°è®¾å¤‡..."
cp "$MODULE_FILE" "$MODULE_PATH" 2>/dev/null || {
  echo "âŒ æ— æ³•å¤åˆ¶é©±åŠ¨æ–‡ä»¶"
  exit 1
}
chmod 600 "$MODULE_PATH"

# æ£€æŸ¥æ¨¡å—æ˜¯å¦å·²åŠ è½½
if lsmod | grep -q "$MODULE_NAME"; then
  echo "âš ï¸  é©±åŠ¨å·²åŠ è½½ï¼Œå…ˆå¸è½½..."
  rmmod "$MODULE_NAME" 2>/dev/null || true
  sleep 1
fi

# åŠ è½½é©±åŠ¨
echo "åŠ è½½é©±åŠ¨..."
if insmod "$MODULE_PATH"; then
  echo "âœ… é©±åŠ¨åŠ è½½æˆåŠŸ"
  
  # éªŒè¯åŠ è½½
  if lsmod | grep -q "$MODULE_NAME"; then
    echo "âœ… æ¨¡å—å·²åœ¨å†…æ ¸ä¸­æ³¨å†Œ"
    
    # æ˜¾ç¤ºæ¨¡å—ä¿¡æ¯
    if [ -d "/sys/module/$MODULE_NAME" ]; then
      echo "æ¨¡å—ä¿¡æ¯:"
      echo "  åç§°: $MODULE_NAME"
      echo "  çŠ¶æ€: $(cat /sys/module/$MODULE_NAME/initstate 2>/dev/null || echo 'active')"
      echo "  å¼•ç”¨è®¡æ•°: $(cat /sys/module/$MODULE_NAME/refcnt 2>/dev/null || echo '1')"
    fi
  else
    echo "âš ï¸  æ¨¡å—æœªåœ¨lsmodä¸­æ˜¾ç¤º"
  fi
  
  # æ˜¾ç¤ºå†…æ ¸æ—¥å¿—
  echo "æœ€è¿‘çš„å†…æ ¸æ¶ˆæ¯:"
  dmesg | tail -20 | grep -i "$MODULE_NAME\|crypto\|evt" || echo "æ— ç›¸å…³æ—¥å¿—"
  
else
  echo "âŒ é©±åŠ¨åŠ è½½å¤±è´¥"
  echo "=== è¯¦ç»†é”™è¯¯ ==="
  insmod "$MODULE_PATH" 2>&1
  echo ""
  echo "=== å†…æ ¸æ—¥å¿— ==="
  dmesg | tail -30
  exit 1
fi

echo ""
echo "âœ… é©±åŠ¨åŠ è½½å®Œæˆ"
EOF
          
          chmod 755 output/load_driver.sh
          
          # ç”Ÿæˆæ„å»ºæŠ¥å‘Š
          cat > output/build_report.txt << 'EOF'
OnePlus Pad Pro å†…æ ¸é©±åŠ¨æ„å»ºæŠ¥å‘Š
==================================
æ„å»ºæ—¶é—´: $(date)
å†…æ ¸ç‰ˆæœ¬: 6.1.118
æ„å»ºç³»ç»Ÿ: GitHub Actions Ubuntu 22.04
ç¼–è¯‘å™¨: Google Clang

ä½¿ç”¨è¯´æ˜:
1. å°† crypto_evt.ko å’Œ load_driver.sh å¤åˆ¶åˆ°è®¾å¤‡
2. åœ¨è®¾å¤‡ä¸Šæ‰§è¡Œ: sh load_driver.sh
3. æŸ¥çœ‹ dmesg è·å–è¯¦ç»†åŠ è½½ä¿¡æ¯

æ³¨æ„: éœ€è¦rootæƒé™å’Œå†…æ ¸ç‰ˆæœ¬åŒ¹é…
EOF
          
          echo "ğŸ“¦ æ‰“åŒ…æ–‡ä»¶æ¸…å•ï¼š"
          ls -la output/

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-PadPro-Complete-Build
          path: |
            output/
          retention-days: 30
          if-no-files-found: error