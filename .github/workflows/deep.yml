name: OnePlus Pad Pro 6.1.118-android14 Driver Build (Clang)
on:
  push:
    branches: [main]
    paths:
      - .github/cmboo.c
      - .github/.config
      - .github/workflows/build-6.1.118-clang.yml
  workflow_dispatch:
jobs:
  build-driver:
    runs-on: ubuntu-22.04
    steps:
      - name: æ¸…ç†+ç©ºé—´æ£€æŸ¥
        run: |
          rm -rf ~/.cache/* ~/.npm ~/.yarn ~/.local/share 2>/dev/null || true
          FREE_SPACE=$(df -h / | awk 'NR==2 {print $4}' | sed 's/G//')
          (( $(echo "$FREE_SPACE < 10" | bc -l) )) && { echo "âŒ ç©ºé—´ä¸è¶³20GB"; exit 1; }
          echo "âœ… å‰©ä½™ç©ºé—´ï¼š$FREE_SPACE GB"
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: å®‰è£…ä¾èµ–ï¼ˆç²¾ç®€+éªŒè¯ï¼‰
        run: |
          sudo apt update && sudo apt install -y --no-install-recommends \
            git make libssl-dev bc libelf-dev python3 python3-pip zlib1g-dev bison flex \
            gcc-multilib g++-multilib rsync binutils-aarch64-linux-gnu
          sudo pip3 install pyelftools --no-cache-dir
          sudo apt remove -y clang llvm lld || true && sudo apt autoremove -y && sudo apt clean
          # å®‰è£…è°·æ­ŒClang
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/android-14.0.0_r1/clang-r487747c.tar.gz
          sudo mkdir -p /opt/clang && sudo tar -zxf clang-r487747c.tar.gz -C /opt/clang
          # å·¥å…·è½¯é“¾æ¥
          sudo ln -s /usr/bin/aarch64-linux-gnu-nm /opt/clang/bin/aarch64-linux-android-nm
          sudo ln -s /usr/bin/aarch64-linux-gnu-objdump /opt/clang/bin/aarch64-linux-android-objdump
          sudo ln -s /usr/bin/aarch64-linux-gnu-objcopy /opt/clang/bin/aarch64-linux-android-objcopy
          sudo ln -s /usr/bin/aarch64-linux-gnu-strip /opt/clang/bin/aarch64-linux-android-strip
          sudo ln -s /opt/clang/bin/clang /opt/clang/bin/aarch64-linux-android-clang
          sudo ln -s /opt/clang/bin/ld.lld /opt/clang/bin/aarch64-linux-android-ld.lld
          # å¼ºåˆ¶éªŒè¯å·¥å…·
          /opt/clang/bin/clang --version || { echo "âŒ Clangå¤±è´¥"; exit 1; }
          /opt/clang/bin/aarch64-linux-android-strip --version || { echo "âŒ stripå¤±è´¥"; exit 1; }
          rm -rf clang-r487747c.tar.gz
      - name: å†…æ ¸æºç å‡†å¤‡ï¼ˆä¼˜åŒ–æ­¥éª¤ï¼Œå¢åŠ å®¹é”™ï¼‰
        run: |
          mkdir -p ~/android-kernel && cd ~/android-kernel
          echo "ğŸ” å…‹éš†å†…æ ¸æºç  (android14-6.1.118_r00)..."
          git clone --branch android14-6.1 --single-branch --depth 150 https://android.googlesource.com/kernel/common gki-6.1.118
          cd gki-6.1.118
          git fetch origin 367540fdf98147e0e5cd42d42ff4867ebd8ea7ef && git checkout $_
          echo "âœ… å†…æ ¸æºç å°±ç»ª: $(git log --oneline -1)"
          # å…³é”®ï¼šæ›¿æ¢ä¸ºæ‰‹æœºæå–çš„.config
          cp $GITHUB_WORKSPACE/.github/.config .config
          echo "ğŸ› ï¸ ç”Ÿæˆå†…æ ¸é…ç½®..."
          # ç”Ÿæˆé…ç½®ï¼Œå°è¯•å¿½ç•¥å¯èƒ½çš„ç™½åå•è­¦å‘Š
          make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
               CC=/opt/clang/bin/clang LD=/opt/clang/bin/ld.lld olddefconfig -j$(nproc) 2>&1 | grep -E "(è­¦å‘Š|é”™è¯¯|WARNING|ERROR)" || true
          echo "ğŸ”§ å‡†å¤‡æ¨¡å—æ„å»ºç¯å¢ƒ (modules_prepare)..."
          # å‡†å¤‡æ¨¡å—æ„å»ºï¼Œæ•è·å…³é”®è¾“å‡º
          make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
               CC=/opt/clang/bin/clang LD=/opt/clang/bin/ld.lld modules_prepare -j$(nproc) 2>&1 | tail -50
          # æ ¸å¿ƒæ£€æŸ¥ï¼šç¬¦å·è¡¨æ˜¯å¦ç”Ÿæˆ
          if [ -f "Module.symvers" ] && [ -s "Module.symvers" ]; then
              SYM_COUNT=$(wc -l < Module.symvers)
              echo "âœ… Module.symvers å·²ç”Ÿæˆï¼ŒåŒ…å« $SYM_COUNT ä¸ªç¬¦å·"
          else
              echo "âš ï¸  è­¦å‘Š: Module.symvers æœªç”Ÿæˆæˆ–ä¸ºç©ºï¼Œå°è¯•ç›´æ¥ç”Ÿæˆ..."
              # å°è¯•ç›´æ¥ç”Ÿæˆç¬¦å·è¡¨
              make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
                   CC=/opt/clang/bin/clang LD=/opt/clang/bin/ld.lld Module.symvers -j$(nproc) 2>/dev/null || true
              if [ -f "Module.symvers" ]; then
                  echo "âœ… å·²é€šè¿‡å¤‡ç”¨æ–¹æ³•ç”Ÿæˆ Module.symvers"
              else
                  echo "âŒ æ— æ³•ç”Ÿæˆ Module.symversï¼Œé©±åŠ¨ç¼–è¯‘å¯èƒ½å¤±è´¥"
                  # ä¸ç«‹å³é€€å‡ºï¼Œè®©ç¼–è¯‘æ­¥éª¤å°è¯•
              fi
          fi
          # æ¸…ç†æ— ç”¨æ–‡ä»¶é‡Šæ”¾ç©ºé—´
          rm -rf .git Documentation samples
          echo "âœ… å†…æ ¸æºç å‡†å¤‡å®Œæˆ"
      - name: ç¼–è¯‘é©±åŠ¨ï¼ˆä¿®å¤è·¯å¾„ä¸é€‰é¡¹ï¼‰
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘é©±åŠ¨æ¨¡å—..."
          # åˆ›å»ºé©±åŠ¨ç›®å½•å¹¶å¤åˆ¶æºç 
          mkdir -p gki-driver
          cp .github/cmboo.c gki-driver/
          cd gki-driver
          # ç¼–å†™Makefileï¼ˆå…³é”®ä¿®æ­£ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
          cat > Makefile << 'EOF'
          obj-m += cmboo.o
          # ã€å…³é”®ä¿®æ­£ã€‘ä½¿ç”¨ç»å¯¹è·¯å¾„æ›¿ä»£ ~
          KERNELDIR ?= /home/runner/android-kernel/gki-6.1.118
          PWD := $(shell pwd)
          ARCH := arm64
          CC := /opt/clang/bin/clang
          LD := /opt/clang/bin/ld.lld
          CROSS_COMPILE := /opt/clang/bin/aarch64-linux-android-
          # ç®€åŒ–ç¼–è¯‘é€‰é¡¹ï¼Œé¿å…å†²çª
          EXTRA_CFLAGS := -Wno-error -Wno-unused-parameter -Wno-implicit-function-declaration -O2
          all:
          	@echo "ç¼–è¯‘é©±åŠ¨ (ä¾èµ–å†…æ ¸: $(KERNELDIR))..."
          	$(MAKE) -C $(KERNELDIR) M=$(PWD) ARCH=$(ARCH) CC=$(CC) LD=$(LD) CROSS_COMPILE=$(CROSS_COMPILE) modules
          	@cp cmboo.ko crypto_evt.ko
          	/opt/clang/bin/aarch64-linux-android-strip --strip-debug crypto_evt.ko
          	@echo "é©±åŠ¨ç¼–è¯‘å®Œæˆ"
          clean:
          	rm -f *.ko *.o *.mod.c *.mod.o .*.cmd
          EOF
          # å¼ºåˆ¶ç¼–è¯‘ï¼ˆå¤±è´¥ç›´æ¥ä¸­æ–­ï¼‰
          echo "æ‰§è¡Œ make å‘½ä»¤..."
          if make -j$(nproc) V=1 2>&1; then
              echo "âœ… make å‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
          else
              echo "âŒ é©±åŠ¨ç¼–è¯‘å¤±è´¥ (make å‘½ä»¤é”™è¯¯)"
              exit 1
          fi
          # å¼ºåˆ¶æ ¡éªŒäº§ç‰©ï¼ˆåŒé‡ä¿é™©ï¼‰
          if [ ! -f "crypto_evt.ko" ]; then
              echo "âŒ é”™è¯¯ï¼šé©±åŠ¨æ–‡ä»¶ crypto_evt.ko æœªç”Ÿæˆ"
              exit 1
          fi
          # åŸºç¡€éªŒè¯
          echo "ğŸ“Š äº§ç‰©éªŒè¯:"
          file crypto_evt.ko
          echo "å¤§å°: $(du -h crypto_evt.ko | cut -f1)"
          # æ£€æŸ¥æœªå®šä¹‰ç¬¦å·æ•°é‡
          UNDEF_SYMS=$(/opt/clang/bin/aarch64-linux-android-nm crypto_evt.ko 2>/dev/null | grep " U " | wc -l || echo "æ£€æŸ¥å¤±è´¥")
          echo "æœªå®šä¹‰ç¬¦å·æ•°é‡: $UNDEF_SYMS"
          if [ "$UNDEF_SYMS" -gt 20 ] && [ "$UNDEF_SYMS" != "æ£€æŸ¥å¤±è´¥" ]; then
              echo "âš ï¸  è­¦å‘Šï¼šæœªå®šä¹‰ç¬¦å·è¾ƒå¤šï¼Œå¯èƒ½å½±å“åŠ è½½"
              /opt/clang/bin/aarch64-linux-android-nm crypto_evt.ko 2>/dev/null | grep " U " | head -5
          fi
          echo "âœ… é©±åŠ¨ç¼–è¯‘æˆåŠŸ"
      - name: ç”ŸæˆåŠ è½½è„šæœ¬ï¼ˆç§»é™¤å±é™©æ“ä½œï¼‰
        run: |
          mkdir -p output
          cat > output/load_driver.sh << 'EOF'
          #!/system/bin/sh
          set -euo pipefail
          MOD_PATH="/data/local/tmp/crypto_evt.ko"
          MOD_DIR=$(dirname $MOD_PATH)
          mkdir -p $MOD_DIR && chmod 700 $MOD_DIR
          [ -f "./crypto_evt.ko" ] && cp ./crypto_evt.ko $MOD_PATH || { echo "é©±åŠ¨æœªæ‰¾åˆ°ï¼"; exit 1; }
          chmod 600 $MOD_PATH
          # åŠ è½½é©±åŠ¨
          echo "åŠ è½½é©±åŠ¨: $MOD_PATH"
          if insmod $MOD_PATH; then
            echo "âœ… é©±åŠ¨åŠ è½½æˆåŠŸ"
            echo "æ¨¡å—ä¿¡æ¯:"
            echo "  åç§°: $(cat /sys/module/cmboo/initstate 2>/dev/null || echo 'æœªçŸ¥')"
            echo "  çŠ¶æ€: $(cat /sys/module/cmboo/initstate 2>/dev/null || echo 'æœªçŸ¥')"
          else
            echo "âŒ é©±åŠ¨åŠ è½½å¤±è´¥"
            echo "=== insmod è¯¦ç»†é”™è¯¯ ==="
            insmod $MOD_PATH 2>&1
            echo ""
            echo "=== æœ€è¿‘å†…æ ¸æ—¥å¿— (dmesg) ==="
            dmesg | tail -30
            exit 1
          fi
          EOF
          chmod 755 output/load_driver.sh
          echo "âœ… åŠ è½½è„šæœ¬å·²ç”Ÿæˆ"
          ls -la output/
      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-PadPro-6.1.118-Driver
          path: |
            gki-driver/crypto_evt.ko
            gki-driver/Makefile
            output/load_driver.sh
          retention-days: 30
          if-no-files-found: error
