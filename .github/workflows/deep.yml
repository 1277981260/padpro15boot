name: OnePlus Pad Pro 6.1.118-android14 Driver Build (Clang)
on:
  push:
    branches: [main]
    paths:
      - .github/cmboo.c
      - .github/.config
      - .github/workflows/build-6.1.118-clang.yml
  workflow_dispatch:
jobs:
  build-driver:
    runs-on: ubuntu-22.04
    steps:
      - name: æ¸…ç†+ç©ºé—´æ£€æŸ¥
        run: |
          rm -rf ~/.cache/* ~/.npm ~/.yarn ~/.local/share 2>/dev/null || true
          FREE_SPACE=$(df -h / | awk 'NR==2 {print $4}' | sed 's/G//')
          (( $(echo "$FREE_SPACE < 10" | bc -l) )) && { echo "âŒ ç©ºé—´ä¸è¶³20GB"; exit 1; }
          echo "âœ… å‰©ä½™ç©ºé—´ï¼š$FREE_SPACE GB"

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: å®‰è£…ä¾èµ–ï¼ˆç²¾ç®€+éªŒè¯ï¼‰
        run: |
          sudo apt update && sudo apt install -y --no-install-recommends \
            git make libssl-dev bc libelf-dev python3 python3-pip zlib1g-dev bison flex \
            gcc-multilib g++-multilib rsync binutils-aarch64-linux-gnu
          sudo pip3 install pyelftools --no-cache-dir
          sudo apt remove -y clang llvm lld || true && sudo apt autoremove -y && sudo apt clean
          
          # å®‰è£…è°·æ­ŒClangï¼ˆAndroid 14.0.0_r1ï¼‰
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/android-14.0.0_r1/clang-r487747c.tar.gz
          sudo mkdir -p /opt/clang && sudo tar -zxf clang-r487747c.tar.gz -C /opt/clang
          
          # å·¥å…·é“¾è½¯é“¾æ¥ï¼ˆç¡®ä¿å‘½åä¸€è‡´æ€§ï¼‰
          sudo ln -sf /usr/bin/aarch64-linux-gnu-nm /opt/clang/bin/aarch64-linux-android-nm
          sudo ln -sf /usr/bin/aarch64-linux-gnu-objdump /opt/clang/bin/aarch64-linux-android-objdump
          sudo ln -sf /usr/bin/aarch64-linux-gnu-objcopy /opt/clang/bin/aarch64-linux-android-objcopy
          sudo ln -sf /usr/bin/aarch64-linux-gnu-strip /opt/clang/bin/aarch64-linux-android-strip
          sudo ln -sf /opt/clang/bin/clang /opt/clang/bin/aarch64-linux-android-clang
          sudo ln -sf /opt/clang/bin/ld.lld /opt/clang/bin/aarch64-linux-android-ld.lld
          
          # éªŒè¯å·¥å…·é“¾
          /opt/clang/bin/clang --version || { echo "âŒ Clangå®‰è£…å¤±è´¥"; exit 1; }
          /opt/clang/bin/ld.lld --version || { echo "âŒ LLDå®‰è£…å¤±è´¥"; exit 1; }
          aarch64-linux-gnu-strip --version || { echo "âŒ stripå·¥å…·é“¾å¼‚å¸¸"; exit 1; }
          rm -f clang-r487747c.tar.gz

      - name: å†…æ ¸æºç å‡†å¤‡ï¼ˆå…³é”®ä¿®æ­£ï¼šä¿®å¤ç™½åå•é—®é¢˜ï¼‰
        run: |
          mkdir -p ~/android-kernel && cd ~/android-kernel
          
          # 1. å…‹éš†ç‰¹å®šç‰ˆæœ¬çš„GKIå†…æ ¸æºç 
          git clone --branch android14-6.1 --single-branch --depth 1 \
            https://android.googlesource.com/kernel/common gki-6.1.118
          cd gki-6.1.118
          
          # åˆ‡æ¢åˆ°ä¸ä½ æ‰‹æœºå®Œå…¨åŒ¹é…çš„æäº¤ï¼ˆandroid14-6.1.118_r00ï¼‰
          git checkout 367540fdf98147e0e5cd42d42ff4867ebd8ea7ef
          
          # 2. ã€æ ¸å¿ƒä¿®å¤ã€‘é…ç½®å¤„ç†
          # å¤åˆ¶æ‰‹æœºæå–çš„é…ç½®æ–‡ä»¶
          cp $GITHUB_WORKSPACE/.github/.config .config
          
          # åˆ é™¤å¯èƒ½å¯¼è‡´é—®é¢˜çš„ç™½åå•é…ç½®ï¼ˆå…³é”®æ­¥éª¤ï¼‰
          sed -i '/CONFIG_UNUSED_KSYMS_WHITELIST/d' .config
          
          # æ·»åŠ ç©ºçš„ç™½åå•é…ç½®ï¼Œç»•è¿‡æ„å»ºæ£€æŸ¥
          echo 'CONFIG_UNUSED_KSYMS_WHITELIST=""' >> .config
          
          # å¯é€‰ï¼šç¦ç”¨æ¨¡å—ç‰ˆæœ¬æ ¡éªŒï¼ˆå¦‚ç¬¦å·é—®é¢˜ä»å­˜åœ¨ï¼Œå¯å¯ç”¨ï¼‰
          # sed -i '/CONFIG_MODVERSIONS/d' .config
          # echo 'CONFIG_MODVERSIONS=n' >> .config
          
          # 3. ç”Ÿæˆé€‚é…çš„é…ç½®
          echo "ğŸ”„ ç”Ÿæˆå†…æ ¸é…ç½®..."
          make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
               CC=/opt/clang/bin/clang LD=/opt/clang/bin/ld.lld olddefconfig -j$(nproc)
          
          # 4. å‡†å¤‡æ¨¡å—æ„å»ºç¯å¢ƒï¼ˆç”ŸæˆModule.symversï¼‰
          echo "ğŸ”„ å‡†å¤‡æ¨¡å—æ„å»ºç¯å¢ƒ..."
          make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
               CC=/opt/clang/bin/clang LD=/opt/clang/bin/ld.lld modules_prepare -j$(nproc)
          
          # 5. éªŒè¯ç¬¦å·è¡¨ç”Ÿæˆ
          if [ ! -f "Module.symvers" ] || [ ! -s "Module.symvers" ]; then
              echo "âŒ é”™è¯¯ï¼šModule.symversæœªç”Ÿæˆæˆ–ä¸ºç©º"
              echo "è°ƒè¯•ä¿¡æ¯ï¼š"
              ls -la Module.symvers 2>/dev/null || echo "æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
          fi
          SYM_COUNT=$(wc -l < Module.symvers)
          echo "âœ… å†…æ ¸ç¬¦å·è¡¨å·²ç”Ÿæˆï¼ŒåŒ…å« $SYM_COUNT ä¸ªç¬¦å·"
          
          # 6. æ¸…ç†é‡Šæ”¾ç©ºé—´
          rm -rf .git Documentation samples
          echo "âœ… å†…æ ¸æºç å‡†å¤‡å®Œæˆ"

      - name: ç¼–è¯‘é©±åŠ¨ï¼ˆä¼˜åŒ–æ„å»ºå‚æ•°ï¼‰
        run: |
          # åˆ›å»ºé©±åŠ¨ç›®å½•
          mkdir -p gki-driver
          cp .github/cmboo.c gki-driver/
          cd gki-driver
          
          # ç”ŸæˆMakefileï¼ˆé€‚é…GKIå†…æ ¸ï¼‰
          cat > Makefile << 'EOF'
          # é©±åŠ¨æ¨¡å—åç§°
          obj-m += cmboo.o
          
          # å†…æ ¸è·¯å¾„
          KERNELDIR ?= ~/android-kernel/gki-6.1.118
          PWD := $(shell pwd)
          
          # æ¶æ„å’Œå·¥å…·é“¾
          ARCH := arm64
          CC := /opt/clang/bin/clang
          LD := /opt/clang/bin/ld.lld
          CROSS_COMPILE := /opt/clang/bin/aarch64-linux-android-
          
          # é¢å¤–æ ‡å¿—ï¼ˆé’ˆå¯¹GKIå†…æ ¸ä¼˜åŒ–ï¼‰
          EXTRA_CFLAGS := \
            -Wno-error \
            -Wno-unused-parameter \
            -Wno-implicit-function-declaration \
            -Wno-incompatible-pointer-types \
            -fno-pic \
            -fvisibility=hidden \
            -O2
          
          # æ„å»ºç›®æ ‡
          all:
          	@echo "ğŸ”¨ ç¼–è¯‘é©±åŠ¨æ¨¡å—..."
          	$(MAKE) -C $(KERNELDIR) \
          		M=$(PWD) \
          		ARCH=$(ARCH) \
          		CC=$(CC) \
          		LD=$(LD) \
          		CROSS_COMPILE=$(CROSS_COMPILE) \
          		modules \
          		-j$(shell nproc) \
          		V=1
          	
          	# é‡å‘½åå¹¶ç²¾ç®€æ¨¡å—
          	@cp cmboo.ko crypto_evt.ko
          	/opt/clang/bin/aarch64-linux-android-strip --strip-debug crypto_evt.ko
          	@echo "âœ… é©±åŠ¨ç¼–è¯‘å®Œæˆ"
          	
          	# æ¸…ç†ä¸­é—´æ–‡ä»¶ä½†ä¿ç•™ç¬¦å·è¡¨
          	rm -f *.mod.c *.mod.o *.o .*.cmd
          
          clean:
          	rm -f *.ko *.o *.mod.c *.mod.o .*.cmd modules.order Module.symvers
          	$(MAKE) -C $(KERNELDIR) M=$(PWD) clean
          EOF
          
          # ç¼–è¯‘é©±åŠ¨
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘é©±åŠ¨..."
          make -j$(nproc) V=1 2>&1 | tee build.log || {
              echo "âŒ é©±åŠ¨ç¼–è¯‘å¤±è´¥"
              echo "=== æ„å»ºæ—¥å¿—æœ«å°¾ ==="
              tail -50 build.log
              exit 1
          }
          
          # éªŒè¯ç¼–è¯‘äº§ç‰©
          if [ ! -f "crypto_evt.ko" ]; then
              echo "âŒ é”™è¯¯ï¼šé©±åŠ¨æ–‡ä»¶æœªç”Ÿæˆ"
              exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶ç±»å‹å’Œæ¶æ„
          FILE_INFO=$(file crypto_evt.ko)
          if echo "$FILE_INFO" | grep -q "ARM aarch64"; then
              echo "âœ… æ¶æ„éªŒè¯é€šè¿‡ï¼šARM aarch64"
          else
              echo "âš ï¸  æ¶æ„è­¦å‘Šï¼š$FILE_INFO"
          fi
          
          # æ£€æŸ¥æœªå®šä¹‰ç¬¦å·æ•°é‡ï¼ˆåº”å°½å¯èƒ½å°‘ï¼‰
          UNDEF_SYMBOLS=$(nm crypto_evt.ko | grep " U " | wc -l)
          echo "ğŸ“Š æœªå®šä¹‰ç¬¦å·æ•°é‡ï¼š$UNDEF_SYMBOLS"
          
          if [ $UNDEF_SYMBOLS -gt 5 ]; then
              echo "âš ï¸  è­¦å‘Šï¼šæœªå®šä¹‰ç¬¦å·è¾ƒå¤šï¼Œå¯èƒ½å½±å“åŠ è½½"
              nm crypto_evt.ko | grep " U " | head -10
          fi
          
          echo "âœ… é©±åŠ¨ç¼–è¯‘æˆåŠŸï¼Œå¤§å°ï¼š$(du -h crypto_evt.ko | cut -f1)"
          ls -la crypto_evt.ko

      - name: ç”ŸæˆåŠ è½½è„šæœ¬ï¼ˆå®‰å…¨å¢å¼ºç‰ˆï¼‰
        run: |
          mkdir -p output
          
          cat > output/load_driver.sh << 'EOF'
          #!/system/bin/sh
          # OnePlus Pad Pro é©±åŠ¨åŠ è½½è„šæœ¬
          # ç‰ˆæœ¬ï¼š1.0 (å®‰å…¨å¢å¼º)
          
          set -euo pipefail
          
          # é…ç½®å‚æ•°
          MODULE_NAME="cmboo"
          MODULE_FILE="crypto_evt.ko"
          TARGET_DIR="/data/local/tmp"
          MODULE_PATH="$TARGET_DIR/$MODULE_FILE"
          
          # æ£€æŸ¥Rootæƒé™
          if [ $(id -u) -ne 0 ]; then
              echo "âŒ éœ€è¦Rootæƒé™"
              exit 1
          fi
          
          # å‡†å¤‡ç›®å½•
          mkdir -p $TARGET_DIR
          chmod 755 $TARGET_DIR
          
          # å¤åˆ¶é©±åŠ¨æ–‡ä»¶
          if [ ! -f "./$MODULE_FILE" ]; then
              echo "âŒ é”™è¯¯ï¼šé©±åŠ¨æ–‡ä»¶ $MODULE_FILE æœªæ‰¾åˆ°"
              exit 1
          fi
          
          cp "./$MODULE_FILE" $MODULE_PATH
          chmod 644 $MODULE_PATH
          
          # å¸è½½å·²æœ‰æ¨¡å—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if lsmod | grep -q $MODULE_NAME; then
              echo "ğŸ”„ å¸è½½ç°æœ‰æ¨¡å—..."
              rmmod $MODULE_NAME 2>/dev/null || true
              sleep 1
          fi
          
          # å°è¯•åŠ è½½é©±åŠ¨
          echo "ğŸ”„ åŠ è½½é©±åŠ¨æ¨¡å—..."
          if insmod $MODULE_PATH 2>/dev/null; then
              echo "âœ… é©±åŠ¨åŠ è½½æˆåŠŸ"
              
              # éªŒè¯æ¨¡å—çŠ¶æ€
              if [ -d "/sys/module/$MODULE_NAME" ]; then
                  echo "ğŸ“Š æ¨¡å—ä¿¡æ¯ï¼š"
                  echo "   åç§°ï¼š$MODULE_NAME"
                  echo "   çŠ¶æ€ï¼š$(cat /sys/module/$MODULE_NAME/initstate 2>/dev/null || echo 'unknown')"
                  echo "   å¼•ç”¨è®¡æ•°ï¼š$(cat /sys/module/$MODULE_NAME/refcnt 2>/dev/null || echo 'unknown')"
              fi
          else
              echo "âŒ é©±åŠ¨åŠ è½½å¤±è´¥"
              echo "=== è¯¦ç»†é”™è¯¯ä¿¡æ¯ ==="
              
              # æ˜¾ç¤ºinsmodçš„å…·ä½“é”™è¯¯
              insmod $MODULE_PATH 2>&1 | head -20
              
              echo "=== ç›¸å…³å†…æ ¸æ—¥å¿— ==="
              dmesg | grep -E "(cmboo|$MODULE_NAME|insmod)" | tail -20
              
              # æ£€æŸ¥ç¬¦å·é—®é¢˜
              echo "=== ç¬¦å·æ£€æŸ¥ ==="
              if command -v nm >/dev/null 2>&1; then
                  echo "æ¨¡å—ä¸­çš„æœªå®šä¹‰ç¬¦å·ï¼š"
                  nm $MODULE_PATH 2>/dev/null | grep " U " | head -10
              fi
              
              exit 1
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          # rm -f $MODULE_PATH
          
          echo "âœ… è„šæœ¬æ‰§è¡Œå®Œæˆ"
          EOF
          
          chmod 755 output/load_driver.sh
          
          # åˆ›å»ºç®€æ˜“æµ‹è¯•è„šæœ¬
          cat > output/test_module.sh << 'EOF'
          #!/system/bin/sh
          # æ¨¡å—æµ‹è¯•è„šæœ¬
          
          MODULE="cmboo"
          
          if [ ! -f "/sys/module/$MODULE/initstate" ]; then
              echo "æ¨¡å—æœªåŠ è½½"
              exit 1
          fi
          
          echo "æ¨¡å—çŠ¶æ€ï¼š$(cat /sys/module/$MODULE/initstate)"
          echo "å¼•ç”¨è®¡æ•°ï¼š$(cat /sys/module/$MODULE/refcnt 2>/dev/null || echo 'N/A')"
          
          # æ£€æŸ¥æ˜¯å¦åœ¨æ¨¡å—åˆ—è¡¨ä¸­
          if lsmod | grep -q $MODULE; then
              echo "âœ… æ¨¡å—å·²æˆåŠŸåŠ è½½å¹¶è¿è¡Œ"
          else
              echo "âš ï¸  æ¨¡å—æœªåœ¨lsmodä¸­åˆ—å‡º"
          fi
          EOF
          
          chmod 755 output/test_module.sh
          
          echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
          ls -la output/

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-Pad-Pro-6.1.118-Driver
          path: |
            gki-driver/crypto_evt.ko
            gki-driver/Makefile
            gki-driver/build.log
            output/
          retention-days: 30
          if-no-files-found: error
          
      - name: æ„å»ºæ‘˜è¦
        if: always()
        run: |
          echo "=== æ„å»ºæ‘˜è¦ ==="
          echo "å†…æ ¸ç‰ˆæœ¬: android14-6.1.118_r00"
          echo "å·¥å…·é“¾: Clang r487747c (Android 14)"
          echo "æ¶æ„: ARM64"
          echo "çŠ¶æ€: ${{ job.status }}"
          echo "æ—¶é—´: $(date)"