name: OnePlus Pad Pro 6.1.118-android14 Driver Build (Clang)
on:
  push:
    branches: [main]
    paths:
      - .github/cmboo.c
      - .github/.config
      - .github/workflows/build-6.1.118-clang.yml
  workflow_dispatch:
jobs:
  build-driver:
    runs-on: ubuntu-22.04
    steps:
      - name: æ¸…ç†+ç©ºé—´æ£€æŸ¥
        run: |
          rm -rf ~/.cache/* ~/.npm ~/.yarn ~/.local/share 2>/dev/null || true
          FREE_SPACE=$(df -h / | awk 'NR==2 {print $4}' | sed 's/G//')
          (( $(echo "$FREE_SPACE < 10" | bc -l) )) && { echo "âŒ ç©ºé—´ä¸è¶³20GB"; exit 1; }
          echo "âœ… å‰©ä½™ç©ºé—´ï¼š$FREE_SPACE GB"

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: å®‰è£…ä¾èµ–ï¼ˆç²¾ç®€+éªŒè¯ï¼‰
        run: |
          sudo apt update && sudo apt install -y --no-install-recommends \
            git make libssl-dev bc libelf-dev python3 python3-pip zlib1g-dev bison flex \
            gcc-multilib g++-multilib rsync binutils-aarch64-linux-gnu
          sudo pip3 install pyelftools --no-cache-dir
          sudo apt remove -y clang llvm lld || true && sudo apt autoremove -y && sudo apt clean
          
          # å®‰è£…è°·æ­ŒClangï¼ˆAndroid 14.0.0_r1ï¼‰
          wget -q https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/tags/android-14.0.0_r1/clang-r487747c.tar.gz
          sudo mkdir -p /opt/clang && sudo tar -zxf clang-r487747c.tar.gz -C /opt/clang
          
          # å·¥å…·é“¾è½¯é“¾æŽ¥
          sudo ln -sf /usr/bin/aarch64-linux-gnu-nm /opt/clang/bin/aarch64-linux-android-nm
          sudo ln -sf /usr/bin/aarch64-linux-gnu-objdump /opt/clang/bin/aarch64-linux-android-objdump
          sudo ln -sf /usr/bin/aarch64-linux-gnu-objcopy /opt/clang/bin/aarch64-linux-android-objcopy
          sudo ln -sf /usr/bin/aarch64-linux-gnu-strip /opt/clang/bin/aarch64-linux-android-strip
          sudo ln -sf /opt/clang/bin/clang /opt/clang/bin/aarch64-linux-android-clang
          sudo ln -sf /opt/clang/bin/ld.lld /opt/clang/bin/aarch64-linux-android-ld.lld
          
          # éªŒè¯å·¥å…·é“¾
          /opt/clang/bin/clang --version || { echo "âŒ Clangå®‰è£…å¤±è´¥"; exit 1; }
          /opt/clang/bin/ld.lld --version || { echo "âŒ LLDå®‰è£…å¤±è´¥"; exit 1; }
          aarch64-linux-gnu-strip --version || { echo "âŒ stripå·¥å…·é“¾å¼‚å¸¸"; exit 1; }
          rm -f clang-r487747c.tar.gz

      - name: å†…æ ¸æºç å‡†å¤‡ï¼ˆä¿®å¤æ·±åº¦é—®é¢˜ï¼‰
        run: |
          mkdir -p ~/android-kernel && cd ~/android-kernel
          
          # ã€å…³é”®ä¿®å¤ã€‘å¢žåŠ å…‹éš†æ·±åº¦åˆ°150ï¼Œç¡®ä¿èƒ½è®¿é—®åˆ°ç›®æ ‡æäº¤
          echo "ðŸ” å…‹éš†å†…æ ¸æºç ï¼ˆæ·±åº¦ï¼š150ï¼‰..."
          git clone --branch android14-6.1 --single-branch --depth 150 \
            https://android.googlesource.com/kernel/common gki-6.1.118
          
          cd gki-6.1.118
          
          # éªŒè¯ç›®æ ‡æäº¤æ˜¯å¦å­˜åœ¨
          echo "ðŸ” æ£€æŸ¥æäº¤æ˜¯å¦å­˜åœ¨..."
          if git cat-file -e 367540fdf98147e0e5cd42d42ff4867ebd8ea7ef 2>/dev/null; then
              echo "âœ… ç›®æ ‡æäº¤å­˜åœ¨äºŽæœ¬åœ°ä»“åº“"
          else
              echo "âš ï¸  ç›®æ ‡æäº¤ä¸åœ¨æµ…å…‹éš†ä¸­ï¼Œæ‹‰å–å®Œæ•´æäº¤..."
              git fetch --depth=200 origin 367540fdf98147e0e5cd42d42ff4867ebd8ea7ef
          fi
          
          # åˆ‡æ¢åˆ°ç›®æ ‡æäº¤
          echo "ðŸ”€ åˆ‡æ¢åˆ°ç›®æ ‡æäº¤ï¼š367540fdf981..."
          git checkout 367540fdf98147e0e5cd42d42ff4867ebd8ea7ef || {
              echo "âŒ æ— æ³•åˆ‡æ¢åˆ°ç›®æ ‡æäº¤"
              echo "å½“å‰åˆ†æ”¯ä¿¡æ¯ï¼š"
              git log --oneline -5
              exit 1
          }
          
          # æ˜¾ç¤ºå½“å‰æäº¤ä¿¡æ¯
          echo "ðŸ“Œ å½“å‰æäº¤ï¼š$(git log --oneline -1)"
          
          # é…ç½®å¤„ç†
          cp $GITHUB_WORKSPACE/.github/.config .config
          
          # åˆ é™¤å¹¶é‡ç½®ç™½åå•é…ç½®
          sed -i '/CONFIG_UNUSED_KSYMS_WHITELIST/d' .config
          echo 'CONFIG_UNUSED_KSYMS_WHITELIST=""' >> .config
          
          # å¯é€‰ï¼šå¦‚éœ€å®Œå…¨ç¦ç”¨æ¨¡å—ç‰ˆæœ¬æ£€æŸ¥ï¼Œå–æ¶ˆä¸‹é¢ä¸¤è¡Œæ³¨é‡Š
          # sed -i '/CONFIG_MODVERSIONS/d' .config
          # echo 'CONFIG_MODVERSIONS=n' >> .config
          
          # ç”Ÿæˆé…ç½®
          echo "âš™ï¸  ç”Ÿæˆå†…æ ¸é…ç½®..."
          make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
               CC=/opt/clang/bin/clang LD=/opt/clang/bin/ld.lld olddefconfig -j$(nproc)
          
          # å‡†å¤‡æ¨¡å—æž„å»ºçŽ¯å¢ƒ
          echo "ðŸ”§ å‡†å¤‡æ¨¡å—æž„å»ºçŽ¯å¢ƒ..."
          make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
               CC=/opt/clang/bin/clang LD=/opt/clang/bin/ld.lld modules_prepare -j$(nproc)
          
          # éªŒè¯ç¬¦å·è¡¨
          if [ ! -f "Module.symvers" ] || [ ! -s "Module.symvers" ]; then
              echo "âŒ é”™è¯¯ï¼šModule.symversæœªç”Ÿæˆ"
              echo "å°è¯•ç”Ÿæˆç¬¦å·è¡¨..."
              # å°è¯•ç›´æŽ¥ç”Ÿæˆç¬¦å·è¡¨
              make ARCH=arm64 CROSS_COMPILE=/opt/clang/bin/aarch64-linux-android- \
                   CC=/opt/clang/bin/clang LD=/opt/clang/bin/ld.lld Module.symvers -j$(nproc) 2>/dev/null || true
          fi
          
          if [ -f "Module.symvers" ]; then
              SYM_COUNT=$(wc -l < Module.symvers)
              echo "âœ… å†…æ ¸ç¬¦å·è¡¨å·²ç”Ÿæˆï¼ŒåŒ…å« $SYM_COUNT ä¸ªç¬¦å·"
          else
              echo "âš ï¸  è­¦å‘Šï¼šModule.symversæœªç”Ÿæˆï¼Œå¯èƒ½å½±å“é©±åŠ¨ç¼–è¯‘"
          fi
          
          # æ¸…ç†
          rm -rf .git Documentation samples
          echo "âœ… å†…æ ¸æºç å‡†å¤‡å®Œæˆ"

      - name: ç¼–è¯‘é©±åŠ¨
        run: |
          mkdir -p gki-driver
          cp .github/cmboo.c gki-driver/
          cd gki-driver
          
          # ç”ŸæˆMakefile
          cat > Makefile << 'EOF'
          obj-m += cmboo.o
          
          KERNELDIR ?= ~/android-kernel/gki-6.1.118
          PWD := $(shell pwd)
          
          ARCH := arm64
          CC := /opt/clang/bin/clang
          LD := /opt/clang/bin/ld.lld
          CROSS_COMPILE := /opt/clang/bin/aarch64-linux-android-
          
          # ç¼–è¯‘é€‰é¡¹ï¼ˆGKIé€‚é…ï¼‰
          EXTRA_CFLAGS := \
            -Wno-error \
            -Wno-unused-parameter \
            -Wno-implicit-function-declaration \
            -Wno-incompatible-pointer-types \
            -fno-pic \
            -O2
          
          all:
          	@echo "ðŸ”¨ ç¼–è¯‘é©±åŠ¨æ¨¡å—..."
          	$(MAKE) -C $(KERNELDIR) \
          		M=$(PWD) \
          		ARCH=$(ARCH) \
          		CC=$(CC) \
          		LD=$(LD) \
          		CROSS_COMPILE=$(CROSS_COMPILE) \
          		modules
          	
          	@cp cmboo.ko crypto_evt.ko
          	/opt/clang/bin/aarch64-linux-android-strip --strip-debug crypto_evt.ko
          	@echo "âœ… é©±åŠ¨ç¼–è¯‘å®Œæˆ"
          
          clean:
          	rm -f *.ko *.o *.mod.c *.mod.o .*.cmd modules.order
          EOF
          
          # ç¼–è¯‘é©±åŠ¨
          echo "ðŸ”¨ å¼€å§‹ç¼–è¯‘é©±åŠ¨..."
          if make -j$(nproc) V=1 2>&1 | tee build.log; then
              echo "âœ… ç¼–è¯‘æˆåŠŸ"
          else
              echo "âŒ ç¼–è¯‘å¤±è´¥"
              echo "=== é”™è¯¯æ—¥å¿— ==="
              tail -100 build.log
              exit 1
          fi
          
          # éªŒè¯äº§ç‰©
          if [ ! -f "crypto_evt.ko" ]; then
              echo "âŒ é”™è¯¯ï¼šé©±åŠ¨æ–‡ä»¶æœªç”Ÿæˆ"
              exit 1
          fi
          
          # åŸºç¡€æ£€æŸ¥
          echo "ðŸ“Š æ–‡ä»¶ä¿¡æ¯ï¼š"
          file crypto_evt.ko
          echo "å¤§å°ï¼š$(du -h crypto_evt.ko | cut -f1)"
          
          # æ£€æŸ¥æœªå®šä¹‰ç¬¦å·
          UNDEF_COUNT=$(nm crypto_evt.ko 2>/dev/null | grep " U " | wc -l || echo "0")
          echo "æœªå®šä¹‰ç¬¦å·æ•°é‡ï¼š$UNDEF_COUNT"
          
          if [ "$UNDEF_COUNT" -gt "10" ]; then
              echo "âš ï¸  è­¦å‘Šï¼šæœªå®šä¹‰ç¬¦å·è¾ƒå¤š"
              nm crypto_evt.ko 2>/dev/null | grep " U " | head -5
          fi

      - name: ç”ŸæˆåŠ è½½è„šæœ¬
        run: |
          mkdir -p output
          
          cat > output/load_driver.sh << 'EOF'
          #!/system/bin/sh
          
          set -e
          
          MODULE="crypto_evt.ko"
          MODULE_NAME="cmboo"
          
          # æ£€æŸ¥æƒé™
          if [ $(id -u) -ne 0 ]; then
              echo "âŒ éœ€è¦Rootæƒé™"
              exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶
          if [ ! -f "$MODULE" ]; then
              echo "âŒ é©±åŠ¨æ–‡ä»¶ä¸å­˜åœ¨: $MODULE"
              exit 1
          fi
          
          # å¸è½½æ—§æ¨¡å—
          if lsmod | grep -q "$MODULE_NAME"; then
              echo "ðŸ”„ å¸è½½æ—§æ¨¡å—..."
              rmmod "$MODULE_NAME" 2>/dev/null || true
              sleep 1
          fi
          
          # åŠ è½½é©±åŠ¨
          echo "ðŸ”„ åŠ è½½é©±åŠ¨..."
          if insmod "$MODULE" 2>/dev/null; then
              echo "âœ… é©±åŠ¨åŠ è½½æˆåŠŸ"
              echo "æ¨¡å—çŠ¶æ€: $(cat /sys/module/$MODULE_NAME/initstate 2>/dev/null || echo 'unknown')"
          else
              echo "âŒ é©±åŠ¨åŠ è½½å¤±è´¥"
              echo "=== è¯¦ç»†é”™è¯¯ ==="
              insmod "$MODULE" 2>&1
              echo ""
              echo "=== å†…æ ¸æ—¥å¿— ==="
              dmesg | tail -20
              exit 1
          fi
          EOF
          
          chmod 755 output/load_driver.sh
          
          # å¤åˆ¶é©±åŠ¨åˆ°outputç›®å½•
          cp gki-driver/crypto_evt.ko output/ 2>/dev/null || true

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-Pad-Pro-Driver-6.1.118
          path: |
            gki-driver/crypto_evt.ko
            gki-driver/build.log
            output/
          retention-days: 30
          if-no-files-found: error