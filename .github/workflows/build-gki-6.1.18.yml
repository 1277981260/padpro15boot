name: 谷歌GKI 6.1驱动编译（需手动修复代码）
on:
  push:
    branches: [main]
    paths: [.github/cmboo.c, .github/workflows/build-gki-6.1.yml]
  workflow_dispatch:

jobs:
  build-driver:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 安装核心依赖
        run: |
          sudo apt update && sudo apt install -y --no-install-recommends \
            git ccache automake flex bison gcc-aarch64-linux-gnu make \
            libssl-dev bc libelf-dev python3 python3-pip
          sudo pip3 install pyelftools
          sudo apt clean

      - name: 获取GKI 6.1源码并准备模块环境
        run: |
          mkdir -p ~/android-kernel && cd ~/android-kernel
          git clone --depth 1 --branch android14-6.1 https://android.googlesource.com/kernel/common gki-6.1
          cd gki-6.1
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- gki_defconfig
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- modules_prepare
          echo "✅ 谷歌GKI 6.1源码准备完成"

      - name: 配置驱动编译环境
        run: |
          if [ ! -f ".github/cmboo.c" ]; then
            echo "ERROR: .github/cmboo.c不存在！" && exit 1
          fi
          mkdir -p gki-driver && cd gki-driver
          cp ../.github/cmboo.c ./

          # 仅修复头文件引用（其他错误需手动修复）
          sed -i 's/#include <linux\/inode.h>/#include <linux\/fs.h>/g' cmboo.c

          cat > Makefile << 'EOF'
          obj-m += cmboo.o
          KERNELDIR ?= ~/android-kernel/gki-6.1
          PWD := $(shell pwd)
          ARCH := arm64
          CROSS_COMPILE := aarch64-linux-gnu-

          EXTRA_CFLAGS := -fvisibility=hidden -ffunction-sections -fdata-sections \
            -DKMI_VERSION=6.1 -DCLEANUP_HOOK_ENABLED -Wno-unused-parameter
          EXTRA_LDFLAGS := -Wl,--gc-sections -Wl,--hash-style=gnu

          all:
          	$(MAKE) -C $(KERNELDIR) M=$(PWD) ARCH=$(ARCH) CROSS_COMPILE=$(CROSS_COMPILE) modules
          	aarch64-linux-gnu-objcopy \
          	  --remove-section=.modinfo \
          	  --remove-section=.gnu.linkonce.this_module \
          	  --remove-section=.note.gnu.build-id \
          	  cmboo.ko crypto_evt.ko

          clean:
          	$(MAKE) -C $(KERNELDIR) M=$(PWD) ARCH=$(ARCH) CROSS_COMPILE=$(CROSS_COMPILE) clean
          	rm -f crypto_evt.ko
          EOF
          echo "✅ 驱动编译配置完成"

      - name: 编译驱动
        run: |
          cd gki-driver
          make -j$(nproc)
          
          [ ! -f "crypto_evt.ko" ] && { echo "ERROR: crypto_evt.ko未生成！"; exit 1; }
          file crypto_evt.ko | grep -q "ARM aarch64" || { echo "ERROR: 架构错误！"; exit 1; }
          echo "✅ 驱动编译成功：$(du -sh crypto_evt.ko | awk '{print $1}')"

      - name: 生成加载脚本
        run: |
          mkdir -p output
          cat > output/load_stealth.sh << 'EOF'
          #!/system/bin/sh
          set -euo pipefail
          MOD_PATH=/data/.hidden/crypto_evt.ko
          insmod $MOD_PATH || {
            echo "兼容模式加载..."
            INIT_ADDR=$(grep init_module /proc/kallsyms | head -1 | awk '{print $1}')
            dd if=$MOD_PATH of=/dev/kmem bs=1 seek=$((0x$INIT_ADDR)) 2>/dev/null
          }
          echo "驱动加载完成"
          EOF
          chmod 755 output/load_stealth.sh

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: 谷歌GKI 6.1驱动
          path: |
            gki-driver/crypto_evt.ko
            output/load_stealth.sh
          retention-days: 30
