name: OnePlus Pad Pro GKI 6.1 Driver Build (Final)
on:
  push:
    branches: [main]
    paths:
      - .github/cmboo.c
      - .github/workflows/build-gki-6.1.yml
  workflow_dispatch: # Support manual trigger

jobs:
  build-driver:
    runs-on: ubuntu-22.04 # Stable for GKI compilation
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 8192
          temp-reserve-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install GKI dependencies
        run: |
          sudo apt update && sudo apt install -y --no-install-recommends \
            git ccache automake flex bison gcc-aarch64-linux-gnu make \
            libssl-dev bc libelf-dev python3 python3-pip
          sudo pip3 install pyelftools
          sudo apt clean && sudo rm -rf /var/lib/apt/lists/*

      - name: Download and configure GKI 6.1 source
        run: |
          mkdir -p ~/android-kernel && cd ~/android-kernel
          git clone --depth 1 --branch android14-6.1 https://android.googlesource.com/kernel/common gki-6.1
          cd gki-6.1
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- gki_defconfig
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- modules_prepare
          echo "✅ GKI 6.1 source prepared"

      - name: Copy driver and configure build env
        run: |
          mkdir -p gki-driver && cd gki-driver
          cp ../.github/cmboo.c ./ || { echo "ERROR: cmboo.c not found!"; exit 1; }

          cat > Makefile << 'EOF'
          obj-m += cmboo.o
          KERNELDIR ?= ~/android-kernel/gki-6.1
          PWD := $(shell pwd)
          ARCH := arm64
          CROSS_COMPILE := aarch64-linux-gnu-

          EXTRA_CFLAGS := -fvisibility=hidden -ffunction-sections -fdata-sections \
            -DKMI_VERSION=6.1 -DCLEANUP_HOOK_ENABLED \
            -Wno-unused-parameter -Wno-error -Wno-implicit-function-declaration \
            -Wno-int-conversion -Wno-unused-variable -Wno-missing-prototypes -Wno-missing-declarations
          EXTRA_LDFLAGS := -Wl,--gc-sections -Wl,--hash-style=gnu

          all:
          	$(MAKE) -C $(KERNELDIR) M=$(PWD) ARCH=$(ARCH) CROSS_COMPILE=$(CROSS_COMPILE) modules
          	cp cmboo.ko crypto_evt.ko
          	rm -f cmboo.ko cmboo.mod.o cmboo.mod.c .cmboo.ko.cmd .cmboo.mod.o.cmd .cmboo.o.cmd

          clean:
          	$(MAKE) -C $(KERNELDIR) M=$(PWD) ARCH=$(ARCH) CROSS_COMPILE=$(CROSS_COMPILE) clean
          	rm -f crypto_evt.ko
          EOF
          echo "✅ Build env configured"

      - name: Compile driver
        run: |
          cd gki-driver
          make -j$(nproc)
          [ ! -f "crypto_evt.ko" ] && { echo "ERROR: crypto_evt.ko not generated!"; exit 1; }
          file crypto_evt.ko | grep -q "ARM aarch64" || { echo "ERROR: Wrong architecture!"; exit 1; }
          echo "✅ Driver built successfully: $(du -sh crypto_evt.ko | awk '{print $1}')"

      - name: Generate load script
        run: |
          mkdir -p output
          cat > output/load_driver.sh << 'EOF'
          #!/system/bin/sh
          set -euo pipefail

          MOD_PATH="/data/.hidden/crypto_evt.ko"
          MOD_DIR=$(dirname $MOD_PATH)

          mkdir -p $MOD_DIR && chmod 700 $MOD_DIR
          [ -f "./crypto_evt.ko" ] && cp ./crypto_evt.ko $MOD_PATH || { echo "Driver not found!"; exit 1; }
          chmod 600 $MOD_PATH

          if insmod $MOD_PATH; then
            echo "✅ Driver loaded successfully"
            echo "Driver version: $(cat /sys/module/cmboo/version 2>/dev/null || echo 'Unknown')"
          else
            echo "⚠️ Normal load failed, try compatible mode..."
            INIT_ADDR=$(grep init_module /proc/kallsyms | head -1 | awk '{print $1}')
            [ -z "$INIT_ADDR" ] && { echo "❌ init_module symbol not found"; exit 1; }
            dd if=$MOD_PATH of=/dev/kmem bs=1 seek=$((0x$INIT_ADDR)) 2>/dev/null
            echo "✅ Compatible mode loaded"
          fi
          EOF
          chmod 755 output/load_driver.sh
          echo "✅ Load script generated"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GKI6.1-Driver-Final-OnePlusPadPro # 纯英文名称，无中文/特殊字符
          path: |
            gki-driver/crypto_evt.ko
            output/load_driver.sh
          retention-days: 30
          if-no-files-found: error
