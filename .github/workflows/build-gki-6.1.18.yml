name: è°·æ­ŒGKI 6.1é©±åŠ¨ç¼–è¯‘ï¼ˆä¿®å¤å¤´æ–‡ä»¶å¼•ç”¨ï¼‰
on:
  push:
    branches: [main]
    paths: [.github/cmboo.c, .github/workflows/build-gki-6.1.yml]
  workflow_dispatch:

jobs:
  build-driver:
    runs-on: ubuntu-22.04
    steps:
      ###########################################################################
      # 1. åŸºç¡€å‡†å¤‡ä¸ä¾èµ–å®‰è£…
      ###########################################################################
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: å®‰è£…æ ¸å¿ƒä¾èµ–
        run: |
          sudo apt update && sudo apt install -y --no-install-recommends \
            git ccache automake flex bison gcc-aarch64-linux-gnu make \
            libssl-dev bc libelf-dev python3 python3-pip
          sudo pip3 install pyelftools
          sudo apt clean

      ###########################################################################
      # 2. æ‹‰å–è°·æ­Œå®˜æ–¹GKI 6.1æºç 
      ###########################################################################
      - name: è·å–GKI 6.1æºç å¹¶å‡†å¤‡æ¨¡å—ç¯å¢ƒ
        run: |
          mkdir -p ~/android-kernel && cd ~/android-kernel
          git clone --depth 1 --branch android14-6.1 https://android.googlesource.com/kernel/common gki-6.1
          cd gki-6.1
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- gki_defconfig
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- modules_prepare
          echo "âœ… è°·æ­ŒGKI 6.1æºç å‡†å¤‡å®Œæˆï¼Œå·²ç”Ÿæˆæ¨¡å—ç¼–è¯‘ç¯å¢ƒ"

      ###########################################################################
      # 3. é…ç½®é©±åŠ¨ç¼–è¯‘ï¼ˆä¿®è¡¥å¤´æ–‡ä»¶å¼•ç”¨ï¼‰
      ###########################################################################
      - name: é…ç½®é©±åŠ¨ç¼–è¯‘ç¯å¢ƒ
        run: |
          if [ ! -f ".github/cmboo.c" ]; then
            echo "ERROR: .github/cmboo.cä¸å­˜åœ¨ï¼" && exit 1
          fi
          mkdir -p gki-driver && cd gki-driver
          cp ../.github/cmboo.c ./

          # ğŸ”§ å…³é”®ä¿®å¤ï¼šå°† <linux/inode.h> æ›¿æ¢ä¸º <linux/fs.h>
          sed -i 's/#include <linux\/inode.h>/#include <linux\/fs.h>/g' cmboo.c

          # é©±åŠ¨Makefileï¼ˆä½¿ç”¨å®˜æ–¹å†…æ ¸Kbuildï¼‰
          cat > Makefile << 'EOF'
          obj-m += cmboo.o
          KERNELDIR ?= ~/android-kernel/gki-6.1
          PWD := $(shell pwd)
          ARCH := arm64
          CROSS_COMPILE := aarch64-linux-gnu-

          EXTRA_CFLAGS := -fvisibility=hidden -ffunction-sections -fdata-sections \
            -DKMI_VERSION=6.1 -DCLEANUP_HOOK_ENABLED -Wno-unused-parameter
          EXTRA_LDFLAGS := -Wl,--gc-sections -Wl,--hash-style=gnu

          all:
          	$(MAKE) -C $(KERNELDIR) M=$(PWD) ARCH=$(ARCH) CROSS_COMPILE=$(CROSS_COMPILE) modules
          	aarch64-linux-gnu-objcopy \
          	  --remove-section=.modinfo \
          	  --remove-section=.gnu.linkonce.this_module \
          	  --remove-section=.note.gnu.build-id \
          	  cmboo.ko crypto_evt.ko

          clean:
          	$(MAKE) -C $(KERNELDIR) M=$(PWD) ARCH=$(ARCH) CROSS_COMPILE=$(CROSS_COMPILE) clean
          	rm -f crypto_evt.ko
          EOF
          echo "âœ… é©±åŠ¨ç¼–è¯‘é…ç½®å®Œæˆï¼Œå·²ä¿®è¡¥å¤´æ–‡ä»¶å¼•ç”¨"

      ###########################################################################
      # 4. ç¼–è¯‘é©±åŠ¨æ¨¡å—
      ###########################################################################
      - name: ç¼–è¯‘é©±åŠ¨ï¼ˆGKI 6.1å®˜æ–¹ç¯å¢ƒï¼‰
        run: |
          cd gki-driver
          make -j$(nproc)
          
          # ä¸¥æ ¼æ ¡éªŒ
          [ ! -f "crypto_evt.ko" ] && { echo "ERROR: crypto_evt.koæœªç”Ÿæˆï¼"; exit 1; }
          file crypto_evt.ko | grep -q "ARM aarch64" || { echo "ERROR: æ¶æ„é”™è¯¯ï¼"; exit 1; }
          echo "âœ… é©±åŠ¨ç¼–è¯‘æˆåŠŸï¼š$(du -sh crypto_evt.ko | awk '{print $1}')"

      ###########################################################################
      # 5. ç”ŸæˆåŠ è½½è„šæœ¬ä¸äº§ç‰©ä¸Šä¼ 
      ###########################################################################
      - name: ç”ŸæˆåŠ è½½è„šæœ¬
        run: |
          mkdir -p output
          cat > output/load_stealth.sh << 'EOF'
          #!/system/bin/sh
          set -euo pipefail
          MOD_PATH=/data/.hidden/crypto_evt.ko
          insmod $MOD_PATH || {
            echo "å…¼å®¹æ¨¡å¼åŠ è½½..."
            INIT_ADDR=$(grep init_module /proc/kallsyms | head -1 | awk '{print $1}')
            dd if=$MOD_PATH of=/dev/kmem bs=1 seek=$((0x$INIT_ADDR)) 2>/dev/null
          }
          echo "é©±åŠ¨åŠ è½½å®Œæˆ"
          EOF
          chmod 755 output/load_stealth.sh

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: è°·æ­ŒGKI 6.1é©±åŠ¨ï¼ˆé€šç”¨é€‚é…ï¼‰
          path: |
            gki-driver/crypto_evt.ko
            output/load_stealth.sh
          retention-days: 30
